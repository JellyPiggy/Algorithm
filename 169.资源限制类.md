# 哈希函数可以把数据按照种类均匀分流

**题目一：32位无符号整数的范围是0~4,294,967,295(接近43亿)，现在有一个正好包含40亿个无符号整数的文件，可以使用最多1GB的内存，怎么找到出现次数最多的数？**

40亿个无符号整数：160亿 byte   约为 16G

那么我们可以用哈希表，它的大小跟整数出现的次数没有关系，而是跟这40亿个整数的种类有关系。因为一个数再怎么多，用哈希表记录的还是对应的key-value，只不过value在增加。而它们分别是4个字节，加起来就是8个字节。

假设最坏情况下，出现的40亿个无符号整数都不相同，则哈希表的大小为40亿 * 8 = 320亿个B，即32G，还不如直接在数组中排序再统计的内存大小。

我们可以反过来想，1G的内存如果用哈希表对数据进行记录，那么可以记录的条数有：1G约等于10亿B，再用10亿除以8，则记录的条数有1亿两千500条。但是哈希表中除了数据外，还有其它的属性会占用空间，因此为了保守起见，就假设该哈希表就只能装1千万条不同种的数据。

因此我们可以用40亿个数 / 1千万 = 400，当一个数来的时候，就可以将该数字用哈希函数，算出一个哈希值后，模上400，那么最后的范围一定是0~399（文件号）。再将该数字放入最后模的文件号当中。因为哈希函数的均匀性，即使是有40亿种不同的数，最后也会均分地放到各个文件当中。

最后再用哈希表计算每个文件中出现次数最多的数，因为 40亿个数 均匀离散到400个文件中，那每个文件数据种数就不会超过 1 千万条，只要每算完一个文件把哈希表内存释放掉再算下一个即可

**推广：**
当一个超级大文件来的时候，给你一个限制条件，一个文件不能超过多少G，当我们发现如果用哈希表直接进行记录时会超出该限制条件。
解决方法：
同样地，对大文件中的数据用哈希函数求出哈希值再%，将大文件分成小文件，然后分开算小文件。（通过哈希函数主要是使得大文件中数据离散均匀的分到小文件中并且同种数据在同一个文件）



**有一个包含100亿个URL的大文件，假设每个URL占用64B，请找出其中所有重复的URL**

先对大文件中的数据用哈希函数求出哈希值，分配到小文件当中。如果该小文件不能满足题目的内存限制要求，就对小文件中的数据再次进行哈希，放入到直到满足题目要求的文件中即可。主要的就是利用多次哈希。



# 位图

**题目二：32位无符号整数的范围是0~4,294,967,295，现在有一个正好包含40亿个无符号整数的文件，所以在整个范围中必然存在没出现过的数。可以使用最多1GB的内存，怎么找到所有未出现过的数？**

位图



**32位无符号整数的范围是0~4294967295，现在有40亿个无符号整数，可以使用最多1GB的内存，找出所有出现了两次的数。**

可以利用位图，建立一个bit数组。每两个bit代表一个数字的出现次数的情况。假设数组最前两个bit位代表的是0，后面两个bit位代表的是1，可以代表1的两个bit位进行统计出现的次数。如果是00，代表1一次都没有出现；如果是01，代表出现了1次；如果是10，代表出现了两次；如果是11，代表出现了三次或三次以上。出现一个数就人为地设置它代表的两个bit位，出现11之后就无需再管它。

最后遍历数组，找出哪个数对应的bit位是10的，那么就说明它出现了两次。

但是，因为我们是用两个bit位代表一个数字的出现次数，假设用一个bit位的时候，数组的大小为：2的32次方 / 8 / 1000 = 536,870,912M，因为是两bit位，则再乘2，超过了1G。那么如何解决？

可以使用分段加位图的思想。我们可以先统计前半部分的2的31次方哪个数出现了两次，再统计后半部分的2的31次方哪个数出现了两次，最后就能够求出这40亿个数哪些数出现了两次。




# 分段统计思想

**内存限制为 3KB，但是只用找到一个没出现过的数即可**

因为内存限制为3KB，则为3000B，如果开辟一个整型数组，那么整型数组的长度为3000B / 4B = 750 。这个是刚好不会超出内存范围的。为了让2的32次方个数能够均分到数组中，我们可以将数组的大小一个离750这个数最近的2的几次方的一个数，即512。所以我们用一个大小为 512 的数组，大小是不会超过限制的

每个数组的一个下标代表的范围大小是2的32次方 / 512 = 8388608

arr[0] 统计 0~ 8388607 范围的数出现几个，arr[1] 统计 8388608 ~ 16,777,215 范围出现多少个……

因为40亿个数是在43亿个数的范围内的，则某些范围的数没有出现，只要找出统计个数小于8388608 的 arr[i] 即可知道哪个范围内有数没有出现。然后就只要在这个小范围上找哪个数没出现就行了，然后小范围继续按上面的方式处理即可

**【进阶】只用有限几个变量，如何在40亿个无符号整数中找出一个没有出现过的数？**

我们可以定义一个L和R，L 到 0 位置，R到2的32次方位置。进行二分，mid 就是在中间的位置，划分左右两边为2的31次方那么多数。就必然存在左右两侧不够2的31次方的情况，再在不够的一侧进行二分，到最后一定能把没出现的数二分出来。

# 堆

**32位无符号整数的范围是0~4294967295，有一个10G大小的文件，每一行都装着这种类型的数字，整个文件是无序的，给你5G的内存空间，请你输出一个10G大小的文件，就是原文件所有数字排序的结果**

先创建一个容器，它是可以排序的，并且能够记录出现的数字与对应的次数。放三条记录。遍历大文件，如果遇到一个数比该容器中出现的最大值小，那么就让容器中的最大值出去，小的数进来。到最后一定是该文件中数字最小的前三名。

例如1出现了1000次，6出现了9万次，13出现了15万次。创建一个大文件，将容器中的数字从小到大并且按统计的次数放多少个，依次放入大文件中。当放完容器中的数后，用一个变量t记住容器中最大的数。当下次遍历大文件的时候，如果出现了小于t的数就不用管统计。重复按照这些步骤，最后的大文件中一定是原来大文件的排序好的结果。

按照题目要求是5G，那么我们可以创建的容器有5G的大小。步骤跟上面的完全一样。容器的结构就是大根堆。


# 题

**32位无符号整数的范围是0~4294967295，现在有40亿个无符号整数，可以使用最多3K的内存，怎么找到这40亿个整数的中位数？**

分段统计思想，将数分为各个区间，然后区间内统计词频，可以知道中位数在哪个区间中，然后再将该区间在分段求解。

同样地，因为是最多3K内存，可以设置一个长度512的数组对2的32次方个数进行划分。在数组中对每个下标代表的数进行统计。如：下标0代表的数是0~8388608。

因为要找出40亿个数的中位数，那么要找出第20亿个数是哪个。如果下标0中出现的数有1亿个，那么中位数绝对不可能出现在下标0代表的某个数中。假设统计0到170下标的数有19亿个，到171下标的数有23亿个，那么中位数肯定就是在171下标代表的某个数中。找到171下标中第一亿个数就是中位数，这里也同样可以用上面的思路。



**求一个大文件中出现次数最多的前100名**

方法：哈希函数分流+堆上堆的方法。

先将大文件用哈希函数求出哈希值分流到小文件中，在小文件中利用大根堆按照出现的次数进行TOP100的排序。最后从各个小文件中取出自己的TOP1，放入到一个新的大根堆中，在新大根堆中按照出现次数排序，这里的TOP1才是全局的TOP1。假设这个TOP1来自二号文件。再从二号文件的TOP2中入新的大根堆，这次的TOP1就是全局的TOP2，以此类推。
